#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

###
### gr8 -- a great command-line utility powered by Ruby
###
### $Release: 0.0.0 $
### $Copyright: copyright(c) 2015 kuwata-lab.com all rights reserved $
### $License: MIT License $
###

require "optparse"


class String

  def q
    #; [!ejo5y] quotes string with single-quoation.
    #; [!ageyj] escapes single-quotation characters.
    "'%s'" % self.gsub(/'/) { "\\'" }
  end

  def qq
    #; [!wwvll] quotes string with double-quotation.
    #; [!rc66j] escapes double-quotation characters.
    '"%s"' % self.gsub(/"/) { '\\"' }
  end

end


module Enumerable

  def transform(&block)
    #; [!peitw] similar to map() or collect(), make each item as self in block.
    collect {|x| x.instance_exec(x, &block) }
  end
  alias xf transform

  def sum
    #; [!9izc1] returns sum of numbers.
    inject(0, :+)
  end

  def sum_i
    #; [!01ehd] returns sum of integers, converting values into integer.
    inject(0) {|t, x| t += x.to_i }
  end

  def sum_f
    #; [!kplnt] returns sum of floats, converting values into float.
    inject(0.0) {|t, x| t += x.to_i }
  end

  def avg
    #; [!pvi8h] returnns average of numbers.
    #; [!poidi] returns nil when no numbers.
    i = 0
    sum = inject(0) {|t, n| i += 1; t += n }
    i == 0 ? nil : sum.to_f / i
  end

  def avg_i
    #; [!btiat] returns average of numbers, converting values into integer.
    #; [!892q9] returns nil when no numbers.
    i = 0
    sum = inject(0) {|t, x| i += 1; t += x.to_i }
    i == 0 ? nil : sum.to_f / i
  end

  def avg_f
    #; [!oqpmc] returns average of numbers, converting values into float.
    #; [!9bckq] returns nil when no numbers.
    i = 0
    sum = inject(0) {|t, x| i += 1; t += x.to_f }
    i == 0 ? nil : sum.to_f / i
  end

end


module Gr8

  VERSION = "$Release: 0.0.0 $".split()[1]

  HELP = <<'END'
%{script} -- great command-line utility powered by Ruby

Usage:
  %{script} [options] ruby-code

Options:
  -h, --help             : print help
  -v, --version          : print version

Example:
  $ cat data
  Haruhi   100
  Mikuru    80
  Yuki     120
  $ cat data | %{script}s 'map{|s|s.split()[1]}'
  100
  80
  120
  $ cat data | %{script}s 'map{|s|s.split()[1]}.map(&:to_i).inject(0,:+)'
  300

See https://github.com/kwatch/gr8 for details.
END


  class App

    def run(*args)
      #
      begin
        opts = parse_options(args)
      rescue ::OptionParser::InvalidOption => ex
        $stderr.puts "#ERROR (#{script_name()}): #{ex}"
        return 1
      end
      #
      output = handle_opts(opts)
      if output
        puts output
        return 0
      end
      #
      errmsg = validate_args(args)
      if errmsg
        $stderr.puts "ERROR (#{script_name()}): #{errmsg}"
        return 1
      end
      #; [!r69d6] executes ruby code with $stdin.lazy as self.
      code = args[0]
      $IN = $stdin.lazy
      define_singleton_methods_on($IN)
      filename = "<#{script_name()}>"
      val = $IN.instance_eval(code, filename)
      #; [!hsvnd] prints nothing when result is nil.
      #; [!eiaa6] prints each item when result is Enumerable.
      #; [!6pfay] prints value when result is not nil nor Enumerable.
      case val
      when nil        ; nil
      when Enumerable ; val.each {|x| puts x }
      else            ; puts val
      end
      #; [!h5wln] returns 0 as status code when executed successfully.
      return 0
    end

    def main(argv=ARGV)
      #; [!w9kb8] exit with status code 0 when executed successfully.
      #; [!nbag1] exit with status code 1 when execution failed.
      args = argv.dup
      status = run(*args)
      exit status
    end

    private

    def script_name
      @script_name ||= File.basename($0)
    end

    def parse_options(args)
      #; [!5efp5] returns Hash object containing command-line options.
      #; [!wdzss] modifies args.
      opts = {}
      parser = OptionParser.new
      parser.on("-h", "--help")    {|v| opts[:help]    = true }
      parser.on("-v", "--version") {|v| opts[:version] = true }
      parser.parse!(args)
      return opts
    end

    def handle_opts(opts)
      #; [!33bj3] prints help message when '-h' or '--help' specified.
      if opts[:help]
        return HELP % {script: script_name()}
      end
      #; [!2tfh5] prints version string when '-v' or '--version' specified.
      if opts[:version]
        return VERSION
      end
      nil
    end

    def validate_args(args)
      #; [!7wqyh] prints error when no argument.
      #; [!bwiqv] prints error when too many argument.
      if args.length == 0
        return "argument required."
      elsif args.length > 1
        return "too many arguments."
      end
      nil
    end

    def define_singleton_methods_on(stdin)
      (class << stdin; self; end).class_eval do
        #; [!zcxh1] removes '\n' from each line automatically.
        alias __each_orig each
        def each
          __each_orig {|s| s.chomp!; yield s }
        end
        alias __each_new each
        #; [!i7npb] $1, $2, ... are available in grep() block argument.
        #; [!vkt64] lines are chomped automatically in grep() if block is not given.
        def grep(pattern, &block)
          if pattern.is_a?(Regexp) && block
            (class << self; self; end).class_eval { alias each __each_orig }
          end
          super(pattern, &block)
        end
      end
    end

  end


end


if __FILE__ == $0
  Gr8::App.new.main()
end
